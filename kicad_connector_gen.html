<script>
	const y_init = -2.54
	const y_step = -5.08
	/*! From raw text parse and return array of dictionary with keys: 
	 * index - pin number, 
	 * label - pin name
	 */
	function get_parsed_pins(raw_list){
		const split_regex = new RegExp('^(\\S+)\[\\t\\s\]+(\\S+)$');
		sort_list = []
		pins = raw_list.split("\n")
		
		pins.forEach(function (item, index) {
			if (item.match(split_regex) != null) {
				temp = split_regex.exec(item)
				sort_list.push({"index":temp[1], "label":temp[2]})
			}
		});
		
		return sort_list;
	};
	
	/*!
	 *  Main process for build kicad symbol structure
	 */
	function process(){
		const split_regex = /^(\S*)[\t\s]*(.*)$/gm;
		pins = get_parsed_pins(document.getElementById("pin_list").value);
		symbl_name = document.getElementById("symbol_name").value;
		// Symbol header
		symbol_text	= `(symbol "${symbl_name}" (pin_numbers hide) (pin_names hide) (in_bom yes) (on_board yes)\r\n`
		symbol_text	+= `(property "Reference" "${document.getElementById("symbol_ref").value}" (id 0) (at -19.05 7.62 0)(effects (font (size 2 2))))\r\n`
		symbol_text	+= `(property "Value" "${symbl_name}" (id 1) (at 7.62 7.62 0)(effects (font (size 2 2))))\r\n`
		symbol_text	+= `(property "Footprint" "" (id 2) (at 20.32 7.62 0)(effects (font (size 1.27 1.27)) hide))\r\n`
		symbol_text	+= `(property "Datasheet" "${document.getElementById("symbol_ds").value}" (id 3) (at -2.54 21.59 0) (effects (font (size 1.27 1.27)) hide))\r\n`
		symbol_text	+= `(property "ki_locked" "" (id 4) (at 0 0 0) (effects (font (size 1.27 1.27))))\r\n`
		symbol_text	+= `(property "ki_keywords" "" (id 5) (at 0 0 0) (effects (font (size 1.27 1.27)) hide) )\r\n`
		symbol_text	+= `(property "ki_description" "${document.getElementById("symbol_desc").value}" (id 6) (at 0 0 0) (effects (font (size 1.27 1.27)) hide))\r\n`
		
		// Symbol frame drawer
		symbol_text += `(symbol "${symbl_name}_1_0"\r\n`
        symbol_text += `(rectangle (start -20.32 5.08) (end 10.16 ${y_step*pins.length})(stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
        
        for (i=0; ; i+=y_step) { 
			symbol_text += `(polyline(pts(xy -20.32 ${i})(xy 10.16 ${i}))(stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
			if(i < y_step*(pins.length-1))
				break;
        }
      
        symbol_text +=`(polyline (pts(xy 0 5.08) (xy 0 ${y_step*pins.length})) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none))))\r\n`
		symbol_text +=`(symbol "${symbl_name}_1_1"\r\n`
    
		// Signal name list
		pos_y = y_init
		pins.forEach(function (item, index) {
			symbol_text += `(text "${item["index"]}" (at 4.826 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`	
			pos_y += y_step;
		});
		
		// Connector pins text
		pos_y = y_init
		pins.forEach(function (item, index) {
			symbol_text += `(text "${item["label"]}" (at -8.89 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`	
			pos_y += y_step;
		});
		
		symbol_text += "(text \"Цепь\" (at -10.16 2.54 0)(effects (font (size 2.0066 2.0066))))\r\n"
		
		// Pins
		pos_y = y_init
		pins.forEach(function (item, index) {
			symbol_text += `(pin passive line (at 15.24 ${pos_y.toFixed(3)} 180) (length 5.08) `
			symbol_text += `(name "${item["label"]}" (effects (font (size 1.27 1.27)))) `
			symbol_text += `(number "${item["index"]}" (effects (font (size 1.27 1.27)))))\r\n`
			pos_y += y_step;
		});
		
		document.getElementById("output").value = symbol_text + "))";
	};
</script>

<body>
	<h1>Connector symbol generator</h1>
	<div>Place in left textarea list of pin in format "pin_number pin_name" and click on Generate button, take from right textarea text and past it to necesary *.kicad_sym file</div>
	<hr>
	<div><table>
		<tr>
			<th>Symbol name</th><td><input id="symbol_name" type="text" value="Symbl"></td>
			<th>Reference</th><td><input id="symbol_ref" type="text" value="A"></td>
			<th>Description</th><td><input id="symbol_desc" type="text"></td>
			<th>Datasheet</th><td><input id="symbol_ds" type="text"></td>	
		</tr>
	</table></div>
	<div><table>
		<tr>
			<th>Pin list</th>
			<th>Result</th>
		</tr>
		<tr>
			<td><textarea id="pin_list" rows="40" cols="80">12 cool_pin</textarea></td>
			<td><textarea id="output" rows="40" cols="80" readonly></textarea></td>
		</tr>
	</table></div>
	<div>
		<input type="button" value="Generate" onclick="process()">
	</div>
</body>
