
<script>
	const pin_regex = new RegExp('^\[\\t\\s\]*(\\S+)\[\\t\\s\]+(\\S+)\[\\t\\s\]*(PI|PO|IO|I|O)?.*?$');
	const func_name_regex = new RegExp('^\[\\t\\s\]*>\[\\t\\s\]*(\\S+)$');
	const y_init = -2.54
	const y_step = -5.08
	const pin_types ={"PO": "power_out", "PI":"power_in", "IO": "bidirectional", "I": "input", "O": "output"}
	
	window.onload = function () {
		out_text = "empty - passive<br>"
		for (var key in pin_types) {
			if (pin_types.hasOwnProperty(key)) {           
				out_text += `"${key}" - ${pin_types[key]}<br>`;
			}
		}
		    
		document.getElementById("pin_types_info").innerHTML = out_text
		
		document.getElementById("description").innerHTML = `Place in left textarea list of pin in format: "pin_number pin_name [pin_type] [additional info]".<br> 
									After generation take from right textarea text and past it into necesary *.kicad_sym file, or use Save file button to save symbol in separate *.kicad_sym file.<br> 
									Place empty stroke and/or functional name (format: ">Functional name") in pin list to delimeter pin by group. Each group generate separete unit in symbol.<br>`
		
	};
	
	
</script>

<!DOCTYPE html>
<!-- Template by Quackit.com -->
<html lang="en">
	
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>Portal 1</title>

    <!-- Bootstrap Core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS: You can use this stylesheet to override any Bootstrap styles and/or apply your own styles -->
    <link href="../css/custom.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
        <div class="container">
            <!-- Logo and responsive toggle -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-globe"></span> Logo</a>
            </div>
            <!-- Navbar links -->
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="../index.html">Home</a></li>
                    <li><a href="https://github.com/gpav3l/kicad_web_helper">About</a></li>
                </ul>

            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

<div class="container-fluid">

		<!-- Left Column -->
		<div class="col-sm-3">
			<div class="panel panel-default">				
				<div class="panel-heading">
						<h1 class="panel-title"><span class="glyphicon glyphicon-cog"></span> Tips image</h1>
					</div>
				<div class="panel-body">
					<img style="max-width:100%;max-height:100%;" src="../images/conn_gen_tips.png" alt="Tips image">
				</div>
				
				<div class="panel-heading">
						<h1 class="panel-title"><span class="glyphicon glyphicon-cog"></span> Avaible pin types</h1>
					</div>
				<div class="panel-body">
					<p id="pin_types_info"></p>
				</div>
				
				<div class="panel-heading">
						<h1 class="panel-title"><span class="glyphicon glyphicon-cog"></span> Description</h1>
					</div>
				<div class="panel-body">
					<p id="description"></p>
				</div>	
			</div>			
		</div><!--/Left Column-->
  
  
		<!-- Center Column -->
		<div class="col-sm-6">
			<!-- Articles -->			
			<div class="row">
			<div class="panel panel-default">
			<div class="panel-heading">
					<h1 class="panel-title"><span class="glyphicon glyphicon-cog"></span> Config</h1>
				</div>
			<div class="panel-body">
				<table><tr><th>Reference</th><td><input id="symbol_ref" type="text" value="XP" width="3" size="3"></td></tr>
				<tr><th>Symbol name</th><td><input id="symbol_name" type="text" value="Connector"></td></tr>
				<tr><td>&nbsp;</td></tr>
				<table>
					<tr><th>Description</th><td><input style="width:100%;" id="symbol_desc" type="text" value="" size="90"></td></tr>	
					<tr><th>Datasheet</th><td><input style="width:100%;" id="symbol_ds" type="text" size="90"></td></tr>
				</table>
				</table>
			</div>
			<div class="list-group">
				<list>
				<ul><input id="is_gnd_concate" type="checkbox"> Show only one GND pins (hide other)</ul>
				</list>
			</div>
			</div>
			</div><hr>
			
			<!-- Work table -->
			<div class="row">
				<button onclick="openFile(dispFile)">Open</button><label> or type below</label>
<textarea class="data_input" id="pin_list" rows="40" cols="60">
>Test
1 GND PI Ground pin
2 VCC PI Power pin
3 GPIO IO Digital Input/Output 1
5 GND PI Ground pin

>Functional
4 GPI I Digital Input/Output 2
10 AGND Analog power rail
6 VCC Power pin
7 AVCC Analog power rail
8 AGND Analog power rail</textarea>
			</div>
		
		<!-- Control and launch -->
		
					
		</div><!--/Center Column-->


	  <!-- Right Column -->
	  <div class="col-sm-3">
		
	  </div><!--/Right Column -->

	</div><!--/container-fluid-->

<div id="popup_result" class="overlay">
	<div class="popup">
		<h2>Result</h2>
		<a class="close" href="#">&times;</a>
		<div class="content ">
			<textarea class="gen_result" id="output" readonly></textarea>
		</div>
		<div>
			<button onclick="save_file()">Save file</button>
		</div>
	</div>
</div>
<div class="box">
	<button onclick="process()">Generate symbol</button>
</div>

	
    <!-- jQuery -->
    <script src="../js/jquery-1.11.3.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../js/bootstrap.min.js"></script>
	
	<!-- IE10 viewport bug workaround -->
	<script src="../js/ie10-viewport-bug-workaround.js"></script>
	
	<!-- Placeholder Images -->
	<script src="../js/holder.min.js"></script>
	
</body>

<script>
	/*!
	 * Print out file content into input textarea
	 */
	function dispFile(contents) {
	  document.getElementById('pin_list').innerHTML=contents
	}
	
	/*!
	 * Catch file select
	 */
	function clickElem(elem) {
		var eventMouse = document.createEvent("MouseEvents")
		eventMouse.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
		elem.dispatchEvent(eventMouse)
	}
	
	/*!
	 * Show open file dialog
	 */
	function openFile(func) {
		readFile = function(e) {
			var file = e.target.files[0];
			if (!file) {
				return;
			}
			var reader = new FileReader();
			reader.onload = function(e) {
				var contents = e.target.result;
				fileInput.func(contents)
				document.body.removeChild(fileInput)
			}
			reader.readAsText(file)
		}
		fileInput = document.createElement("input")
		fileInput.type='file'
		fileInput.accept='.txt'
		fileInput.style.display='none'
		fileInput.onchange=readFile
		fileInput.func=func
		document.body.appendChild(fileInput)
		clickElem(fileInput)
	}
	
	/*! 
	 * Parse text to pin list
	 */
	function get_parsed_pins(raw_list){		
		sort_list = []
		sub_list = []
		func_name = "";
		
		lines = raw_list.split("\n")
		
		lines.forEach(function (item, index) {
			if(item == "" | (item.match(func_name_regex) != null)) {
				if(sub_list.length != 0) { 
					sort_list.push({fname: func_name, pin_list: sub_list});
					sub_list = []
				}
			
				if(item.match(func_name_regex) != null) { 
					func_name = func_name_regex.exec(item)[1];
				} else {
					func_name = "";
				}				
			} else {
				if (item.match(pin_regex) != null) {
					pin_type = "passive"
					temp = pin_regex.exec(item)
					if(temp[3] !== undefined) pin_type = pin_types[temp[3]]
					sub_list.push({"index":temp[1], "label":temp[2], "type":pin_type})
				}
			}
		});
		
		if(sub_list.length != 0) sort_list.push({fname: func_name, pin_list: sub_list});
		
		return sort_list;
	};
	
	/*!
	*  Generate symbol property
	*/
	function symbol_property_gen() {
		sym_prop = [{prop: "Reference", value: document.getElementById("symbol_ref").value, pos_x: -19.05, pos_y: 7.62, font: 2},
		{prop: "Value", value: document.getElementById("symbol_name").value, pos_x: -2.54, pos_y: 7.62, font: 2},
		{prop: "Footprint", value: "", pos_x: 20.32, pos_y: 7.62, font: 2},
		{prop: "Datasheet", value: document.getElementById("symbol_ds").value, pos_x: -2.54, pos_y: 21.59, font: 1.27},
		{prop: "ki_locked", value: "", pos_x: 0, pos_y: 0, font: 1.27},
		{prop: "ki_keywords", value: "", pos_x: 0, pos_y: 0, font: 1.27},
		{prop: "ki_description", value: document.getElementById("symbol_desc").value, pos_x: 0, pos_y: 0, font: 1.27},
		]
		
		return_text = "";
		sym_prop.forEach(function (item, index) {
			return_text += `(property "${item["prop"]}" "${item["value"]}" (id ${index}) `;
			return_text += `(at ${item["pos_x"]} ${item["pos_y"]} 0) `;
			return_text += `(effects (font (size ${item["font"]} ${item["font"]}))))\r\n`
		});
		
		return return_text;
	}
	
	/*!
	 *	Check pin to duplicate
	 */
	function is_id_duplicate(pins_list) {
		result = "";
		id_dict = {};
		pins_list.forEach(function(list) {
			list["pin_list"].forEach(function(item) {
				if(id_dict[item["index"]] === undefined) id_dict[item["index"]]= "1";
				else result = item["index"];
			});
		});
		return result;
	}
	
	/*!
	 *  Main process for build kicad symbol structure
	 */
	function process(){
		pins_groups = get_parsed_pins(document.getElementById("pin_list").value);
		symbl_name = document.getElementById("symbol_name").value;
		is_gnd_concate = document.getElementById("is_gnd_concate").checked;
		
		if((dupl_id = is_id_duplicate(pins_groups)) != "") {
			document.getElementById("output").value = "";
			alert("Found duplicated pins id: " + dupl_id);
			return;
		}
		// Symbol header
		symbol_text	= `(symbol "${symbl_name}" (pin_numbers hide) (pin_names hide) (in_bom yes) (on_board yes)\r\n`
		
		symbol_text	+= symbol_property_gen();
		
		// Unit generation
		pins_groups.forEach(function(pins, index) {
			show_pin_count = 0
			first_grp_pin = {}
			/* Text and pins generation */
			symbol_pins =`(symbol "${symbl_name}_${index+1}_1"\r\n`
			
			// Pin and name field
			pos_y = y_init
			pins["pin_list"].forEach(function(item) {
				pin_name = item["label"].toUpperCase()
				if(is_gnd_concate & /\S*GND\S*/.test(pin_name)) {
					if(first_grp_pin[pin_name] === undefined) {
						first_grp_pin[pin_name] = pos_y;
					}else {
						temp_y = first_grp_pin[pin_name].toFixed(3)
						symbol_pins += `(pin  ${item["type"]} line (at 15.24 ${temp_y} 180) (length 5.08) hide`
						symbol_pins += `(name "${item["label"]}" (effects (font (size 1.27 1.27)))) `
						symbol_pins += `(number "${item["index"]}" (effects (font (size 1.27 1.27)))))\r\n`
						return;		
					}
				}
				symbol_pins += `(text "${item["index"]}" (at 4.826 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`
				symbol_pins += `(text "${item["label"]}" (at -8.89 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`
				symbol_pins += `(pin ${item["type"]} line (at 15.24 ${pos_y.toFixed(3)} 180) (length 5.08) `
				symbol_pins += `(name "${item["label"]}" (effects (font (size 1.27 1.27)))) `
				symbol_pins += `(number "${item["index"]}" (effects (font (size 1.27 1.27)))))\r\n`		
				pos_y += y_step;
				show_pin_count++;				
			});
			
			symbol_pins += "(text \"Цепь\" (at -10.16 2.54 0)(effects (font (size 2 2))))\r\n"
			if(pins["fname"] != "") {
				symbol_pins += `(text "${pins["fname"]}" (at -3.81 ${show_pin_count*y_step+y_init} 0)(effects (font (size 2.0066 2.0066))))\r\n`
			}
			
			/* Lines generation */
			symbol_lines = `(symbol "${symbl_name}_${index+1}_0"\r\n`
			symbol_lines += `(rectangle (start -20.32 5.08) (end 10.16 ${y_step*show_pin_count}) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
			
			for (i=0; ; i+=y_step) { 
				symbol_lines += `(polyline (pts(xy -20.32 ${i}) (xy 10.16 ${i.toFixed(3)})) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
				if(i <= y_step*(show_pin_count-1))
					break;
			}
			symbol_lines +=`(polyline (pts(xy 0 5.08) (xy 0 ${y_step*show_pin_count})) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none))))\r\n`
			
			symbol_text += symbol_lines + symbol_pins + ")\r\n";
		});
		document.getElementById("output").value = symbol_text + ")";
		location.href = "#popup_result";
	};
	
	/*!
	 *  Save .kicad_sim file
	 */
	function save_file() {
		if(document.getElementById("output").value == "") {
			alert("Output is empty")
		} else {
			var a = document.createElement("a");
			a.href = window.URL.createObjectURL(new Blob([document.getElementById("output").value], {type: "text/plain"}));
			a.download = `${document.getElementById("symbol_name").value}.kicad_sym`;
			a.click();
		}
	};
</script>

</html>
