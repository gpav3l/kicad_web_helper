<script>
	const y_init = -2.54
	const y_step = -5.08
	
	/*! From raw text parse and return array of dictionary with keys: 
	 * index - pin number, 
	 * label - pin name
	 */
	function get_parsed_pins(raw_list){
		const split_regex = new RegExp('^(\\S+)\[\\t\\s\]+(\\S+).*?$');
		sort_list = []
		sub_list = []
		lines = raw_list.split("\n")
		
		lines.forEach(function (item, index) {
			if(item == "") {
				if(sub_list.length != 0) sort_list.push(sub_list);
				sub_list = []
			} else {
				if (item.match(split_regex) != null) {
					temp = split_regex.exec(item)
					sub_list.push({"index":temp[1], "label":temp[2]})
				}
			}
		});
		
		if(sub_list.length != 0) sort_list.push(sub_list);
		
		return sort_list;
	};
	
	/*!
	*  Generate symbol property
	*/
	function symbol_property_gen() {
		sym_prop = [{prop: "Reference", value: document.getElementById("symbol_ref").value, pos_x: -19.05, pos_y: 7.62, font: 2},
		{prop: "Value", value: document.getElementById("symbol_name").value, pos_x: -2.54, pos_y: 7.62, font: 2},
		{prop: "Footprint", value: "", pos_x: 20.32, pos_y: 7.62, font: 2},
		{prop: "Datasheet", value: document.getElementById("symbol_ds").value, pos_x: -2.54, pos_y: 21.59, font: 1.27},
		{prop: "ki_locked", value: "", pos_x: 0, pos_y: 0, font: 1.27},
		{prop: "ki_keywords", value: "", pos_x: 0, pos_y: 0, font: 1.27},
		{prop: "ki_description", value: document.getElementById("symbol_desc").value, pos_x: 0, pos_y: 0, font: 1.27},
		]
		
		return_text = "";
		sym_prop.forEach(function (item, index) {
			return_text += `(property "${item["prop"]}" "${item["value"]}" (id ${index}) `;
			return_text += `(at ${item["pos_x"]} ${item["pos_y"]} 0) `;
			return_text += `(effects (font (size ${item["font"]} ${item["font"]}))))\r\n`
		});
		
		return return_text;
	}
	
	/*!
	 *  Main process for build kicad symbol structure
	 */
	function process(){
		pins_groups = get_parsed_pins(document.getElementById("pin_list").value);
		symbl_name = document.getElementById("symbol_name").value;
		is_gnd_concate = document.getElementById("is_gnd_concate").checked;
		
		// Symbol header
		symbol_text	= `(symbol "${symbl_name}" (pin_numbers hide) (pin_names hide) (in_bom yes) (on_board yes)\r\n`
		
		symbol_text	+= symbol_property_gen();
		
		// Unit generation
		pins_groups.forEach(function(pins, index) {
			show_pin_count = 0
			first_grp_pin = {}
			/* Text and pins generation */
			symbol_pins =`(symbol "${symbl_name}_${index+1}_1"\r\n`
			
			// Pin and name field
			pos_y = y_init
			pins.forEach(function(item) {
				pin_name = item["label"].toUpperCase()
				if(is_gnd_concate & /\S*GND\S*/.test(pin_name)) {
					if(first_grp_pin[pin_name] === undefined) {
						first_grp_pin[pin_name] = pos_y;
					}else {
						temp_y = first_grp_pin[pin_name].toFixed(3)
						symbol_pins += `(pin passive line (at 15.24 ${temp_y} 180) (length 5.08) hide`
						symbol_pins += `(name "${item["label"]}" (effects (font (size 1.27 1.27)))) `
						symbol_pins += `(number "${item["index"]}" (effects (font (size 1.27 1.27)))))\r\n`
						return;		
					}
				}
				symbol_pins += `(text "${item["index"]}" (at 4.826 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`
				symbol_pins += `(text "${item["label"]}" (at -8.89 ${pos_y.toFixed(3)} 0)(effects (font (size 2 2))))\r\n`
				symbol_pins += `(pin passive line (at 15.24 ${pos_y.toFixed(3)} 180) (length 5.08) `
				symbol_pins += `(name "${item["label"]}" (effects (font (size 1.27 1.27)))) `
				symbol_pins += `(number "${item["index"]}" (effects (font (size 1.27 1.27)))))\r\n`		
				pos_y += y_step;
				show_pin_count++;				
			});
			
			symbol_pins += "(text \"Цепь\" (at -10.16 2.54 0)(effects (font (size 2.0066 2.0066))))\r\n"
			if(document.getElementById("symbol_fname").value != null) {
				symbol_pins += `(text "${document.getElementById("symbol_fname").value}" (at -3.81 ${show_pin_count*y_step+y_init} 0)(effects (font (size 2.0066 2.0066))))\r\n`
			}
			
			/* Lines generation */
			symbol_lines = `(symbol "${symbl_name}_${index+1}_0"\r\n`
			symbol_lines += `(rectangle (start -20.32 5.08) (end 10.16 ${y_step*show_pin_count}) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
			
			for (i=0; ; i+=y_step) { 
				symbol_lines += `(polyline (pts(xy -20.32 ${i}) (xy 10.16 ${i})) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none)))\r\n`
				if(i <= y_step*(show_pin_count-1))
					break;
			}
			symbol_lines +=`(polyline (pts(xy 0 5.08) (xy 0 ${y_step*show_pin_count})) (stroke (width 0) (type default) (color 0 0 0 0))(fill (type none))))\r\n`
			
			symbol_text += symbol_lines + symbol_pins + ")\r\n";
		});
		document.getElementById("output").value = symbol_text + ")";
	};
</script>

<body>
	<div><a href="../index.html">Home</a></div>
	<h1>Connector symbol generator</h1>
	<div>Place in left textarea list of pin in format "pin_number pin_name [additional info]" and click on Generate button, take from right textarea text and past it into necesary *.kicad_sym file. 
Place empty stroke in pin list to delimeter pin by group. Each group generate separete unit in symbol.</div>
	<img src="../images/conn_gen_tips.png" alt="Tips image">
	<hr>
	<div><table>
		<tr>
			<th>Reference</th><td><input id="symbol_ref" type="text" value="XP" width="3" size="3"></td>
			<th>Symbol name</th><td><input id="symbol_name" type="text" value="Connector"></td>
			<th>Functional name</th><td><input id="symbol_fname" type="text" value=""></td>	
		</tr>
	</table> </div>
	<div><table>
		<tr><th>Description</th><td><input id="symbol_desc" type="text" value="" size="90"></td></tr>	
		<tr><th>Datasheet</th><td><input id="symbol_ds" type="text" size="90"></td></tr>
	</table></div>
	<div><table>
		<tr>
			<th>Input pin list</th>
			<th>Option</th>
			<th>Result</th>
		</tr>
		<tr>
			<td><textarea id="pin_list" rows="40" cols="40">1 GND Ground pin
2 VCC Power pin
3 GPIO Digital Input/Output 1
5 GND Ground pin

4 GPIO Digital Input/Output 2
10 AGND Analog power rail
6 VCC Power pin
7 AVCC Analog power rail
8 AGND Analog power rail</textarea></td>
			<td>
				<input id="is_gnd_concate" type="checkbox">Concate GND pins<br>
				<input type="button" value="Generate symbol" onclick="process()"><br>
			</td>
			<td><textarea id="output" rows="40" cols="80" readonly></textarea></td>
		</tr>
	</table></div>
</body>
