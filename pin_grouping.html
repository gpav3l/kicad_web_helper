<script>
	/*!
	 * Print out file content into input textarea
	 */
	function dispFile(contents) {
	  document.getElementById('pin_list').innerHTML=contents
	}
	
	/*!
	 * Catch file select
	 */
	function clickElem(elem) {
		var eventMouse = document.createEvent("MouseEvents")
		eventMouse.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
		elem.dispatchEvent(eventMouse)
	}
	
	/*!
	 * Show open file dialog
	 */
	function openFile(func) {
		readFile = function(e) {
			var file = e.target.files[0];
			if (!file) {
				return;
			}
			var reader = new FileReader();
			reader.onload = function(e) {
				var contents = e.target.result;
				fileInput.func(contents)
				document.body.removeChild(fileInput)
			}
			reader.readAsText(file)
		}
		fileInput = document.createElement("input")
		fileInput.type='file'
		fileInput.accept='.txt'
		fileInput.style.display='none'
		fileInput.onchange=readFile
		fileInput.func=func
		document.body.appendChild(fileInput)
		clickElem(fileInput)
	}
	
	/*!
	 * Parse raw input to pin number, pin name and pin description
	 */
	function parse_input(raw_text) {
		parsed_list=[]
		line_list=raw_text.split('\n')
		
		line_list.forEach(function(item, index) {
			temp = item.split(/\s+/);
			if(temp.length >= 3) parsed_list.push({id: temp[0], name: temp[1], info: temp.slice(2).join(' ')})
		});
		
		return parsed_list;
	};
	
	/*!
	 * Sort pin by info field
	 */
	function sort_by_info(list){
		list.sort(function(a,b){
			if(a.info < b.info) { return -1; }
			if(a.info > b.info) { return 1; }
			return 0;
		});
		
		ret_text = `${list[0]["id"]} ${list[0]["name"]} ${list[0]["info"]}\r\n`
		for(i=1; i<list.length; i++){
			if(list[i-1]["info"] != list[i]["info"]) ret_text += "\r\n"
			ret_text += `${list[i]["id"]} ${list[i]["name"]} ${list[i]["info"]}\r\n`
		}
		
		return ret_text;
	};
	
	/*!
	 * Sort pin by name field
	 */
	function sort_by_name(list){
		list.sort(function(a,b){
			if(a.name < b.name) { return -1; }
			if(a.name > b.name) { return 1; }
			return 0;
		});
		
		ret_text = `${list[0]["id"]} ${list[0]["name"]} ${list[0]["info"]}\r\n`
		for(i=1; i<list.length; i++){
			if(list[i-1]["name"] != list[i]["name"]) ret_text += "\r\n"
			ret_text += `${list[i]["id"]} ${list[i]["name"]} ${list[i]["info"]}\r\n`
		}
		
		return ret_text;
	};
	
	/*!
	 *  Main process for build kicad symbol structure
	 */
	function process(){
		list = parse_input(document.getElementById("pin_list").value)
		res_ouput = ""
		
		if(document.getElementById("sort_by_info").checked)
			res_output = sort_by_info(list);
		else if(document.getElementById("sort_by_name").checked)
			res_output = sort_by_name(list);				
		
		document.getElementById("output").value = res_output;
	};
</script>

<body>
	<h1>Tools for split pin list by group</h1>
	<div>Place in left textarea list of pin in format "pin_number pin_name pin_description" and click on Sort button, take from right textarea sorted by group, that can be used to past into *.kicad_sym generation page. </div>
	<hr>
	<div><table>
		<tr>
			<th>Type pin list or <button onclick="openFile(dispFile)">open a file</button></th>
			<th>Options</th>
			<th>Result</th>
		</tr>
		<tr>
			<td><textarea id="pin_list" rows="40" cols="40">1 GND Ground pin
2 VCC Power pin
3 GPIO Digital Input/Output 1
5 GND Ground pin
4 GPIO Digital Input/Output 2
6 VCC Power pin
7 AVCC Analog power rail
8 AGND Analog power rail</textarea></td>
			<td>
				<input id="sort_by_info" type="radio" name="sort_type" checked="checked">Sort by pin info<br>
				<input id="sort_by_name" type="radio" name="sort_type">Sort by pin name<br>
				<input type="button" value="Sort" onclick="process()"><br>
			</td>
			<td><textarea id="output" rows="40" cols="80" readonly></textarea></td>
		</tr>
	</table></div>
</body>
